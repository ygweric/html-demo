<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµè§ˆå™¨æ–‡ä»¶ç®¡ç†å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f0f0;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #fff;
        }
        
        /* å·¥å…·æ  */
        .toolbar {
            background: linear-gradient(180deg, #f9f9f9 0%, #e8e8e8 100%);
            border-bottom: 1px solid #d0d0d0;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toolbar-btn {
            background: transparent;
            border: 1px solid transparent;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }
        
        .toolbar-btn:hover {
            background: rgba(0, 120, 215, 0.1);
            border-color: rgba(0, 120, 215, 0.3);
        }
        
        .toolbar-btn:active {
            background: rgba(0, 120, 215, 0.2);
        }
        
        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toolbar-btn .icon {
            font-size: 16px;
        }
        
        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: #c0c0c0;
            margin: 0 4px;
        }
        
        /* åœ°å€æ  */
        .address-bar {
            background: #fff;
            border-bottom: 1px solid #d0d0d0;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 4px;
        }
        
        .nav-btn {
            background: transparent;
            border: none;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.15s;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: #e5f3ff;
            color: #0078d7;
        }
        
        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .path-box {
            flex: 1;
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #c0c0c0;
            border-radius: 3px;
            padding: 4px 8px;
            min-height: 30px;
        }
        
        .path-box:focus-within {
            border-color: #0078d7;
            box-shadow: 0 0 0 1px rgba(0, 120, 215, 0.3);
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 2px;
        }
        
        .breadcrumb-item {
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            transition: background 0.15s;
        }
        
        .breadcrumb-item:hover {
            background: #e5f3ff;
        }
        
        .breadcrumb-separator {
            color: #999;
            font-size: 12px;
        }
        
        /* æ–‡ä»¶æµè§ˆåŒºåŸŸ */
        .file-browser {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* è¡¨å¤´ */
        .file-header {
            display: grid;
            grid-template-columns: minmax(300px, 2fr) 150px 120px 180px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
            user-select: none;
        }
        
        .header-cell {
            padding: 8px 12px;
            border-right: 1px solid #e0e0e0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .header-cell:hover {
            background: #e8e8e8;
        }
        
        .header-cell:last-child {
            border-right: none;
        }
        
        .sort-icon {
            font-size: 10px;
            opacity: 0.6;
        }
        
        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .file-list {
            list-style: none;
        }
        
        .file-item {
            display: grid;
            grid-template-columns: minmax(300px, 2fr) 150px 120px 180px;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
            cursor: default;
            user-select: none;
            transition: background 0.1s;
        }
        
        .file-item:hover {
            background: #e5f3ff;
        }
        
        .file-item.selected {
            background: #cce8ff;
        }
        
        .file-item.selected:hover {
            background: #b8dfff;
        }
        
        .file-cell {
            padding: 6px 12px;
            font-size: 13px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon {
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .file-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-item.folder .file-name {
            color: #0078d7;
        }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            background: #f5f5f5;
            border-top: 1px solid #d0d0d0;
            padding: 4px 12px;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            text-align: center;
            padding: 40px;
        }
        
        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-weight: 400;
            margin-bottom: 8px;
        }
        
        .empty-state p {
            font-size: 13px;
        }
        
        .empty-state .btn {
            margin-top: 20px;
            background: #0078d7;
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .empty-state .btn:hover {
            background: #106ebe;
        }
        
        .empty-state .btn[style*="background: #666"]:hover {
            background: #555 !important;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e0e0e0;
            border-top-color: #0078d7;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* é”™è¯¯æç¤º */
        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #c00;
            text-align: center;
            padding: 40px;
        }
        
        .error-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        /* æ–‡ä»¶è¯¦æƒ…é¢æ¿ */
        .details-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 320px;
            height: 100%;
            background: #fff;
            border-left: 1px solid #d0d0d0;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.2s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        
        .details-panel.open {
            transform: translateX(0);
        }
        
        .details-header {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .details-header h3 {
            font-size: 14px;
            font-weight: 600;
        }
        
        .details-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 4px 8px;
        }
        
        .details-close:hover {
            color: #333;
        }
        
        .details-content {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
        }
        
        .details-icon {
            text-align: center;
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .details-name {
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 24px;
            word-break: break-word;
        }
        
        .details-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        
        .details-label {
            color: #666;
        }
        
        .details-value {
            color: #333;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        /* å³é”®èœå• */
        .context-menu {
            position: fixed;
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 1000;
            display: none;
        }
        
        .context-menu.show {
            display: block;
        }
        
        .context-menu-item {
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .context-menu-item:hover {
            background: #e5f3ff;
        }
        
        .context-menu-separator {
            height: 1px;
            background: #e0e0e0;
            margin: 4px 0;
        }
        
        /* ==================== å·¦ä¾§è¾¹æ  ==================== */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 240px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }
        
        .sidebar-header h3 {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }
        
        .sidebar-header-actions {
            display: flex;
            gap: 4px;
        }
        
        .sidebar-header-btn {
            background: none;
            border: none;
            padding: 4px 6px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 3px;
            color: #666;
        }
        
        .sidebar-header-btn:hover {
            background: #e5f3ff;
            color: #0078d7;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .saved-folder-list {
            list-style: none;
        }
        
        .saved-folder-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.15s;
            position: relative;
        }
        
        .saved-folder-item:hover {
            background: #e5f3ff;
        }
        
        .saved-folder-item.active {
            background: #cce8ff;
        }
        
        .saved-folder-item .folder-icon {
            font-size: 18px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .saved-folder-item .folder-info {
            flex: 1;
            min-width: 0;
        }
        
        .saved-folder-item .folder-name {
            font-size: 13px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .saved-folder-item .folder-date {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        
        .saved-folder-item .folder-status {
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }
        
        .saved-folder-item .folder-status.granted {
            background: #d4edda;
            color: #155724;
        }
        
        .saved-folder-item .folder-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .saved-folder-item .folder-actions {
            display: none;
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .saved-folder-item:hover .folder-actions {
            display: flex;
            gap: 2px;
        }
        
        .folder-action-btn {
            background: #fff;
            border: 1px solid #ddd;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 3px;
            color: #666;
        }
        
        .folder-action-btn:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }
        
        .folder-action-btn.delete:hover {
            background: #ffe5e5;
            border-color: #ffcccc;
            color: #c00;
        }
        
        .sidebar-empty {
            text-align: center;
            padding: 30px 16px;
            color: #888;
        }
        
        .sidebar-empty .icon {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .sidebar-empty p {
            font-size: 12px;
            line-height: 1.5;
        }
        
        .sidebar-footer {
            padding: 8px;
            border-top: 1px solid #e0e0e0;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .sidebar-footer-btn {
            width: 100%;
            padding: 8px;
            background: #0078d7;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .sidebar-footer-btn:hover {
            background: #106ebe;
        }
        
        .file-browser-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* æŠ˜å ä¾§è¾¹æ  */
        .sidebar.collapsed {
            width: 48px;
        }
        
        .sidebar.collapsed .sidebar-header h3,
        .sidebar.collapsed .sidebar-content,
        .sidebar.collapsed .sidebar-footer {
            display: none;
        }
        
        .sidebar.collapsed .sidebar-header {
            justify-content: center;
            padding: 12px 8px;
        }
        
        .toggle-sidebar-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-radius: 3px;
        }
        
        .toggle-sidebar-btn:hover {
            background: #e5f3ff;
            color: #0078d7;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¥å…·æ  -->
        <div class="toolbar">
            <button id="toggleSidebar" class="toggle-sidebar-btn" title="åˆ‡æ¢ä¾§è¾¹æ ">â˜°</button>
            <div class="toolbar-separator"></div>
            <button id="selectRoot" class="toolbar-btn">
                <span class="icon">ğŸ“‚</span>
                <span>æ‰“å¼€æ–‡ä»¶å¤¹</span>
            </button>
            <div class="toolbar-separator"></div>
            <button id="refreshBtn" class="toolbar-btn" disabled>
                <span class="icon">ğŸ”„</span>
                <span>åˆ·æ–°</span>
            </button>
        </div>
        
        <!-- ä¸»å¸ƒå±€ -->
        <div class="main-layout">
            <!-- å·¦ä¾§è¾¹æ  - ä¿å­˜çš„æ–‡ä»¶å¤¹åˆ—è¡¨ -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3>ğŸ“š å·²æˆæƒæ–‡ä»¶å¤¹</h3>
                    <div class="sidebar-header-actions">
                        <button class="sidebar-header-btn" id="clearAllBtn" title="æ¸…é™¤å…¨éƒ¨">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="sidebar-content">
                    <ul class="saved-folder-list" id="savedFolderList">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </ul>
                    <div class="sidebar-empty" id="sidebarEmpty">
                        <div class="icon">ğŸ“</div>
                        <p>æš‚æ— ä¿å­˜çš„æ–‡ä»¶å¤¹<br>æ‰“å¼€æ–‡ä»¶å¤¹åä¼šè‡ªåŠ¨ä¿å­˜</p>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <button class="sidebar-footer-btn" id="authorizeAllBtn" style="background: #009688;">
                        <span>ğŸ”“</span>
                        <span>ä¸€é”®æˆæƒå…¨éƒ¨</span>
                    </button>
                    <button class="sidebar-footer-btn" id="addFolderBtn">
                        <span>â•</span>
                        <span>æ·»åŠ æ–‡ä»¶å¤¹</span>
                    </button>
                </div>
            </div>
            
            <!-- å³ä¾§ä¸»åŒºåŸŸ -->
            <div class="file-browser-wrapper">
                <!-- åœ°å€æ  -->
                <div class="address-bar">
                    <div class="nav-buttons">
                        <button id="backBtn" class="nav-btn" disabled title="åé€€">â—€</button>
                        <button id="forwardBtn" class="nav-btn" disabled title="å‰è¿›">â–¶</button>
                        <button id="upBtn" class="nav-btn" disabled title="å‘ä¸Š">â–²</button>
                    </div>
                    <div class="path-box">
                        <div class="breadcrumb" id="breadcrumb">
                            <span style="color: #888;">è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹</span>
                        </div>
                    </div>
                </div>
                
                <!-- æ–‡ä»¶æµè§ˆåŒºåŸŸ -->
                <div class="file-browser">
                    <!-- è¡¨å¤´ -->
                    <div class="file-header" id="fileHeader" style="display: none;">
                        <div class="header-cell" data-sort="name">
                            åç§° <span class="sort-icon">â–²</span>
                        </div>
                        <div class="header-cell" data-sort="modified">
                            ä¿®æ”¹æ—¥æœŸ
                        </div>
                        <div class="header-cell" data-sort="type">
                            ç±»å‹
                        </div>
                        <div class="header-cell" data-sort="size">
                            å¤§å°
                        </div>
                    </div>
                    
                    <!-- æ–‡ä»¶åˆ—è¡¨å®¹å™¨ -->
                    <div class="file-list-container" id="fileListContainer">
                        <div class="empty-state" id="emptyState">
                            <div class="icon">ğŸ“</div>
                            <h3>æ¬¢è¿ä½¿ç”¨æ–‡ä»¶ç®¡ç†å™¨</h3>
                            <p>ä»å·¦ä¾§é€‰æ‹©å·²ä¿å­˜çš„æ–‡ä»¶å¤¹ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ–°æ–‡ä»¶å¤¹</p>
                            <button class="btn" id="selectRootAlt">é€‰æ‹©æ–‡ä»¶å¤¹</button>
                        </div>
                        
                        <div class="loading" id="loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <span>æ­£åœ¨åŠ è½½...</span>
                        </div>
                        
                        <div class="error-state" id="errorState" style="display: none;">
                            <div class="icon">âš ï¸</div>
                            <p>æ— æ³•è®¿é—®æ­¤ç›®å½•</p>
                        </div>
                        
                        <ul class="file-list" id="fileList" style="display: none;"></ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <span id="itemCount">0 ä¸ªé¡¹ç›®</span>
            <span id="selectedInfo"></span>
        </div>
    </div>
    
    <!-- æ–‡ä»¶è¯¦æƒ…é¢æ¿ -->
    <div class="details-panel" id="detailsPanel">
        <div class="details-header">
            <h3>è¯¦ç»†ä¿¡æ¯</h3>
            <button class="details-close" id="closeDetails">âœ•</button>
        </div>
        <div class="details-content" id="detailsContent"></div>
    </div>
    
    <!-- å³é”®èœå• -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="menuOpen">
            <span>ğŸ“‚</span> æ‰“å¼€
        </div>
        <div class="context-menu-item" id="menuDetails">
            <span>â„¹ï¸</span> å±æ€§
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="menuRefresh">
            <span>ğŸ”„</span> åˆ·æ–°
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentDirectoryHandle = null;
        let rootDirectoryHandle = null;
        let pathHistory = [];
        let historyIndex = -1;
        let navigationHistory = [];
        let currentItems = [];
        let selectedItem = null;
        let sortBy = 'name';
        let sortAsc = true;
        let db = null;
        
        const DB_NAME = 'FileManagerDB';
        const STORE_NAME = 'directoryHandles';
        
        // DOM å…ƒç´ 
        const selectRootBtn = document.getElementById('selectRoot');
        const selectRootAltBtn = document.getElementById('selectRootAlt');
        const addFolderBtn = document.getElementById('addFolderBtn');
        const authorizeAllBtn = document.getElementById('authorizeAllBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const sidebar = document.getElementById('sidebar');
        const savedFolderList = document.getElementById('savedFolderList');
        const sidebarEmpty = document.getElementById('sidebarEmpty');
        const refreshBtn = document.getElementById('refreshBtn');
        const backBtn = document.getElementById('backBtn');
        const forwardBtn = document.getElementById('forwardBtn');
        const upBtn = document.getElementById('upBtn');
        const breadcrumb = document.getElementById('breadcrumb');
        const fileHeader = document.getElementById('fileHeader');
        const fileList = document.getElementById('fileList');
        const fileListContainer = document.getElementById('fileListContainer');
        const emptyState = document.getElementById('emptyState');
        const loading = document.getElementById('loading');
        const errorState = document.getElementById('errorState');
        const itemCount = document.getElementById('itemCount');
        const selectedInfo = document.getElementById('selectedInfo');
        const detailsPanel = document.getElementById('detailsPanel');
        const detailsContent = document.getElementById('detailsContent');
        const closeDetails = document.getElementById('closeDetails');
        const contextMenu = document.getElementById('contextMenu');
        
        let currentFolderId = null; // å½“å‰æ¿€æ´»çš„æ–‡ä»¶å¤¹ID
        
        // ==================== IndexedDB æ“ä½œ ====================
        
        // åˆå§‹åŒ– IndexedDB
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2); // å‡çº§ç‰ˆæœ¬å·
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    // åˆ é™¤æ—§çš„ storeï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (database.objectStoreNames.contains(STORE_NAME)) {
                        database.deleteObjectStore(STORE_NAME);
                    }
                    // åˆ›å»ºæ–°çš„ store
                    database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                };
            });
        }
        
        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // ä¿å­˜ç›®å½•å¥æŸ„åˆ° IndexedDB
        async function saveDirectoryHandle(handle) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåç§°çš„ç›®å½•ï¼ˆç®€å•å»é‡ï¼‰
            const existing = await getAllSavedDirectories();
            const existingItem = existing.find(item => item.name === handle.name);
            
            if (existingItem) {
                // æ›´æ–°ç°æœ‰è®°å½•
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    
                    existingItem.handle = handle;
                    existingItem.lastAccessedAt = Date.now();
                    
                    const request = store.put(existingItem);
                    request.onsuccess = () => resolve(existingItem.id);
                    request.onerror = () => reject(request.error);
                });
            }
            
            // åˆ›å»ºæ–°è®°å½•
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const id = generateId();
                const data = {
                    id: id,
                    handle: handle,
                    name: handle.name,
                    savedAt: Date.now(),
                    lastAccessedAt: Date.now()
                };
                
                const request = store.put(data);
                request.onsuccess = () => resolve(id);
                request.onerror = () => reject(request.error);
            });
        }
        
        // è·å–æ‰€æœ‰ä¿å­˜çš„ç›®å½•
        async function getAllSavedDirectories() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    // æŒ‰æœ€åè®¿é—®æ—¶é—´æ’åº
                    const results = request.result.sort((a, b) => 
                        (b.lastAccessedAt || b.savedAt) - (a.lastAccessedAt || a.savedAt)
                    );
                    resolve(results);
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        // è·å–å•ä¸ªç›®å½•
        async function getSavedDirectory(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        // æ›´æ–°ç›®å½•çš„æœ€åè®¿é—®æ—¶é—´
        async function updateDirectoryAccessTime(id) {
            const item = await getSavedDirectory(id);
            if (item) {
                item.lastAccessedAt = Date.now();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.put(item);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }
        
        // åˆ é™¤å•ä¸ªç›®å½•
        async function deleteSavedDirectory(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„ç›®å½•
        async function clearAllSavedDirectories() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // æ£€æŸ¥å¹¶è¯·æ±‚æƒé™
        async function verifyPermission(handle, readWrite = false) {
            const options = { mode: readWrite ? 'readwrite' : 'read' };
            
            // æ£€æŸ¥å½“å‰æƒé™çŠ¶æ€
            if ((await handle.queryPermission(options)) === 'granted') {
                return true;
            }
            
            // è¯·æ±‚æƒé™ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’è§¦å‘ï¼‰
            if ((await handle.requestPermission(options)) === 'granted') {
                return true;
            }
            
            return false;
        }
        
        // ==================== ä¾§è¾¹æ æ¸²æŸ“ ====================
        
        // æ¸²æŸ“ä¿å­˜çš„æ–‡ä»¶å¤¹åˆ—è¡¨
        async function renderSavedFolders() {
            const folders = await getAllSavedDirectories();
            savedFolderList.innerHTML = '';
            
            if (folders.length === 0) {
                sidebarEmpty.style.display = 'block';
                return;
            }
            
            sidebarEmpty.style.display = 'none';
            
            // ä½¿ç”¨ for...of ä»¥ä¾¿ä½¿ç”¨ await
            for (const folder of folders) {
                const li = document.createElement('li');
                li.className = 'saved-folder-item' + (folder.id === currentFolderId ? ' active' : '');
                li.dataset.id = folder.id;
                
                const savedDate = new Date(folder.savedAt).toLocaleDateString();
                
                // æ£€æŸ¥æƒé™çŠ¶æ€
                let statusHtml = '';
                try {
                    const permissionState = await folder.handle.queryPermission({ mode: 'read' });
                    if (permissionState === 'granted') {
                        statusHtml = '<span class="folder-status granted">å·²æˆæƒ</span>';
                    } else {
                        statusHtml = '<span class="folder-status pending">éœ€æˆæƒ</span>';
                    }
                } catch (e) {
                    statusHtml = '<span class="folder-status pending">éœ€æˆæƒ</span>';
                }
                
                li.innerHTML = `
                    <span class="folder-icon">ğŸ“</span>
                    <div class="folder-info">
                        <div class="folder-name" title="${folder.name}">${folder.name} ${statusHtml}</div>
                        <div class="folder-date">ä¿å­˜äº ${savedDate}</div>
                    </div>
                    <div class="folder-actions">
                        <button class="folder-action-btn delete" title="åˆ é™¤" data-id="${folder.id}">âœ•</button>
                    </div>
                `;
                
                // ç‚¹å‡»æ‰“å¼€æ–‡ä»¶å¤¹
                li.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('folder-action-btn')) {
                        openSavedFolder(folder.id);
                    }
                });
                
                // åˆ é™¤æŒ‰é’®
                li.querySelector('.delete').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (confirm(`ç¡®å®šè¦åˆ é™¤ "${folder.name}" çš„è®°å½•å—ï¼Ÿ`)) {
                        await deleteSavedDirectory(folder.id);
                        if (folder.id === currentFolderId) {
                            currentFolderId = null;
                            resetToEmptyState();
                        }
                        await renderSavedFolders();
                    }
                });
                
                savedFolderList.appendChild(li);
            }
        }
        
        // æ‰“å¼€ä¿å­˜çš„æ–‡ä»¶å¤¹
        async function openSavedFolder(id) {
            try {
                const saved = await getSavedDirectory(id);
                if (!saved || !saved.handle) {
                    alert('æ— æ³•æ‰¾åˆ°è¯¥æ–‡ä»¶å¤¹è®°å½•');
                    return;
                }
                
                // è¯·æ±‚æƒé™
                const hasPermission = await verifyPermission(saved.handle);
                if (!hasPermission) {
                    alert('æƒé™è¢«æ‹’ç»ï¼Œæ— æ³•è®¿é—®è¯¥ç›®å½•');
                    return;
                }
                
                // æ›´æ–°è®¿é—®æ—¶é—´
                await updateDirectoryAccessTime(id);
                
                currentFolderId = id;
                rootDirectoryHandle = saved.handle;
                currentDirectoryHandle = saved.handle;
                pathHistory = [saved.handle];
                historyIndex = 0;
                navigationHistory = [{ handle: saved.handle, path: [saved.handle] }];
                
                await loadDirectoryContents(saved.handle);
                updateBreadcrumb();
                updateNavigationButtons();
                await renderSavedFolders(); // æ›´æ–°æ¿€æ´»çŠ¶æ€
                
            } catch (error) {
                console.error('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥:', error);
                alert('æ‰“å¼€å¤±è´¥: ' + error.message);
            }
        }
        
        // é‡ç½®åˆ°ç©ºçŠ¶æ€
        function resetToEmptyState() {
            fileHeader.style.display = 'none';
            fileList.style.display = 'none';
            emptyState.style.display = 'flex';
            breadcrumb.innerHTML = '<span style="color: #888;">è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹</span>';
            itemCount.textContent = '0 ä¸ªé¡¹ç›®';
            refreshBtn.disabled = true;
        }
        
        // ==================== äº‹ä»¶ç»‘å®š ====================
        
        // äº‹ä»¶ç»‘å®š
        selectRootBtn.addEventListener('click', selectRootDirectory);
        selectRootAltBtn.addEventListener('click', selectRootDirectory);
        addFolderBtn.addEventListener('click', selectRootDirectory);
        authorizeAllBtn.addEventListener('click', authorizeAllFolders);
        clearAllBtn.addEventListener('click', clearAllFolders);
        toggleSidebarBtn.addEventListener('click', toggleSidebar);
        refreshBtn.addEventListener('click', refreshDirectory);
        backBtn.addEventListener('click', goBack);
        forwardBtn.addEventListener('click', goForward);
        upBtn.addEventListener('click', goUp);
        closeDetails.addEventListener('click', () => detailsPanel.classList.remove('open'));
        
        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
        }
        
        // ä¸€é”®æˆæƒæ‰€æœ‰æ–‡ä»¶å¤¹
        async function authorizeAllFolders() {
            const folders = await getAllSavedDirectories();
            if (folders.length === 0) {
                alert('æ²¡æœ‰ä¿å­˜çš„æ–‡ä»¶å¤¹');
                return;
            }
            
            let successCount = 0;
            let failCount = 0;
            const results = [];
            
            // æ˜¾ç¤ºè¿›åº¦æç¤º
            const originalText = authorizeAllBtn.innerHTML;
            authorizeAllBtn.disabled = true;
            
            for (let i = 0; i < folders.length; i++) {
                const folder = folders[i];
                authorizeAllBtn.innerHTML = `<span>ğŸ”„</span><span>æˆæƒä¸­ ${i + 1}/${folders.length}...</span>`;
                
                try {
                    const hasPermission = await verifyPermission(folder.handle);
                    if (hasPermission) {
                        successCount++;
                        results.push({ name: folder.name, status: 'âœ… å·²æˆæƒ' });
                        // æ›´æ–°è®¿é—®æ—¶é—´
                        await updateDirectoryAccessTime(folder.id);
                    } else {
                        failCount++;
                        results.push({ name: folder.name, status: 'âŒ å·²æ‹’ç»' });
                    }
                } catch (error) {
                    failCount++;
                    results.push({ name: folder.name, status: 'âš ï¸ å¤±è´¥: ' + error.message });
                }
            }
            
            authorizeAllBtn.innerHTML = originalText;
            authorizeAllBtn.disabled = false;
            
            // æ˜¾ç¤ºç»“æœ
            let resultMessage = `æˆæƒå®Œæˆï¼\n\nâœ… æˆåŠŸ: ${successCount} ä¸ª\nâŒ å¤±è´¥: ${failCount} ä¸ª\n\nè¯¦ç»†ç»“æœ:\n`;
            results.forEach(r => {
                resultMessage += `${r.status} ${r.name}\n`;
            });
            
            alert(resultMessage);
            
            // åˆ·æ–°åˆ—è¡¨
            await renderSavedFolders();
        }
        
        // æ¸…é™¤æ‰€æœ‰æ–‡ä»¶å¤¹
        async function clearAllFolders() {
            const folders = await getAllSavedDirectories();
            if (folders.length === 0) {
                alert('æ²¡æœ‰ä¿å­˜çš„æ–‡ä»¶å¤¹');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ ${folders.length} ä¸ªä¿å­˜çš„æ–‡ä»¶å¤¹è®°å½•å—ï¼Ÿ`)) {
                await clearAllSavedDirectories();
                currentFolderId = null;
                resetToEmptyState();
                await renderSavedFolders();
            }
        }
        
        // è¡¨å¤´æ’åº
        document.querySelectorAll('.header-cell').forEach(cell => {
            cell.addEventListener('click', () => {
                const sort = cell.dataset.sort;
                if (sortBy === sort) {
                    sortAsc = !sortAsc;
                } else {
                    sortBy = sort;
                    sortAsc = true;
                }
                updateSortIndicator();
                renderFileList();
            });
        });
        
        // ç‚¹å‡»ç©ºç™½å¤„å–æ¶ˆé€‰æ‹©
        fileListContainer.addEventListener('click', (e) => {
            if (e.target === fileListContainer || e.target === fileList) {
                clearSelection();
            }
        });
        
        // éšè—å³é”®èœå•
        document.addEventListener('click', () => {
            contextMenu.classList.remove('show');
        });
        
        // å³é”®èœå•é¡¹
        document.getElementById('menuOpen').addEventListener('click', () => {
            if (selectedItem) {
                openItem(selectedItem);
            }
        });
        
        document.getElementById('menuDetails').addEventListener('click', () => {
            if (selectedItem) {
                showDetails(selectedItem);
            }
        });
        
        document.getElementById('menuRefresh').addEventListener('click', refreshDirectory);
        
        // é€‰æ‹©æ ¹ç›®å½•
        async function selectRootDirectory() {
            try {
                const directoryHandle = await window.showDirectoryPicker({
                    mode: 'read'
                });
                
                rootDirectoryHandle = directoryHandle;
                currentDirectoryHandle = directoryHandle;
                pathHistory = [directoryHandle];
                historyIndex = 0;
                navigationHistory = [{ handle: directoryHandle, path: [directoryHandle] }];
                
                // ä¿å­˜åˆ° IndexedDB å¹¶è·å–ID
                currentFolderId = await saveDirectoryHandle(directoryHandle);
                
                await loadDirectoryContents(directoryHandle);
                updateBreadcrumb();
                updateNavigationButtons();
                await renderSavedFolders(); // æ›´æ–°ä¾§è¾¹æ 
                
            } catch (error) {
                console.log('ç›®å½•é€‰æ‹©å–æ¶ˆæˆ–å‡ºé”™:', error);
            }
        }
        
        // åŠ è½½ç›®å½•å†…å®¹
        async function loadDirectoryContents(directoryHandle) {
            try {
                showLoading();
                currentItems = [];
                
                for await (const [name, handle] of directoryHandle.entries()) {
                    const item = {
                        name,
                        handle,
                        kind: handle.kind,
                        size: 0,
                        modified: null,
                        type: ''
                    };
                    
                    if (handle.kind === 'file') {
                        try {
                            const file = await handle.getFile();
                            item.size = file.size;
                            item.modified = file.lastModified;
                            item.type = getFileType(name);
                        } catch (e) {
                            // å¿½ç•¥æ— æ³•è¯»å–çš„æ–‡ä»¶
                        }
                    } else {
                        item.type = 'æ–‡ä»¶å¤¹';
                    }
                    
                    currentItems.push(item);
                }
                
                renderFileList();
                hideLoading();
                refreshBtn.disabled = false;
                
            } catch (error) {
                console.error('åŠ è½½ç›®å½•å¤±è´¥:', error);
                showError();
            }
        }
        
        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList() {
            fileList.innerHTML = '';
            
            // æ’åºï¼šæ–‡ä»¶å¤¹åœ¨å‰
            const sorted = [...currentItems].sort((a, b) => {
                // æ–‡ä»¶å¤¹å§‹ç»ˆåœ¨å‰
                if (a.kind !== b.kind) {
                    return a.kind === 'directory' ? -1 : 1;
                }
                
                // æŒ‰é€‰å®šå­—æ®µæ’åº
                let cmp = 0;
                switch (sortBy) {
                    case 'name':
                        cmp = a.name.localeCompare(b.name, 'zh-CN');
                        break;
                    case 'modified':
                        cmp = (a.modified || 0) - (b.modified || 0);
                        break;
                    case 'type':
                        cmp = a.type.localeCompare(b.type, 'zh-CN');
                        break;
                    case 'size':
                        cmp = a.size - b.size;
                        break;
                }
                
                return sortAsc ? cmp : -cmp;
            });
            
            sorted.forEach(item => {
                const li = document.createElement('li');
                li.className = `file-item ${item.kind === 'directory' ? 'folder' : 'file'}`;
                li.dataset.name = item.name;
                
                li.innerHTML = `
                    <div class="file-cell file-name-cell">
                        <span class="file-icon">${item.kind === 'directory' ? 'ğŸ“' : getFileIcon(item.name)}</span>
                        <span class="file-name">${item.name}</span>
                    </div>
                    <div class="file-cell">${item.modified ? formatDate(item.modified) : ''}</div>
                    <div class="file-cell">${item.type}</div>
                    <div class="file-cell">${item.kind === 'file' ? formatFileSize(item.size) : ''}</div>
                `;
                
                // å•å‡»é€‰æ‹©
                li.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectItem(li, item);
                });
                
                // åŒå‡»æ‰“å¼€
                li.addEventListener('dblclick', () => {
                    openItem(item);
                });
                
                // å³é”®èœå•
                li.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    selectItem(li, item);
                    showContextMenu(e.pageX, e.pageY);
                });
                
                fileList.appendChild(li);
            });
            
            fileHeader.style.display = 'grid';
            fileList.style.display = 'block';
            emptyState.style.display = 'none';
            
            // æ›´æ–°çŠ¶æ€æ 
            const folderCount = currentItems.filter(i => i.kind === 'directory').length;
            const fileCount = currentItems.filter(i => i.kind === 'file').length;
            itemCount.textContent = `${currentItems.length} ä¸ªé¡¹ç›® (${folderCount} ä¸ªæ–‡ä»¶å¤¹, ${fileCount} ä¸ªæ–‡ä»¶)`;
        }
        
        // é€‰æ‹©é¡¹ç›®
        function selectItem(element, item) {
            clearSelection();
            element.classList.add('selected');
            selectedItem = item;
            selectedInfo.textContent = `å·²é€‰æ‹©: ${item.name}`;
        }
        
        // æ¸…é™¤é€‰æ‹©
        function clearSelection() {
            document.querySelectorAll('.file-item.selected').forEach(el => {
                el.classList.remove('selected');
            });
            selectedItem = null;
            selectedInfo.textContent = '';
        }
        
        // æ‰“å¼€é¡¹ç›®
        async function openItem(item) {
            if (item.kind === 'directory') {
                currentDirectoryHandle = item.handle;
                pathHistory.push(item.handle);
                
                // æ›´æ–°å¯¼èˆªå†å²
                historyIndex++;
                navigationHistory = navigationHistory.slice(0, historyIndex);
                navigationHistory.push({
                    handle: item.handle,
                    path: [...pathHistory]
                });
                
                await loadDirectoryContents(item.handle);
                updateBreadcrumb();
                updateNavigationButtons();
            } else {
                showDetails(item);
            }
        }
        
        // æ˜¾ç¤ºè¯¦æƒ…
        async function showDetails(item) {
            let content = `
                <div class="details-icon">${item.kind === 'directory' ? 'ğŸ“' : getFileIcon(item.name)}</div>
                <div class="details-name">${item.name}</div>
            `;
            
            if (item.kind === 'file') {
                content += `
                    <div class="details-row">
                        <span class="details-label">ç±»å‹</span>
                        <span class="details-value">${item.type}</span>
                    </div>
                    <div class="details-row">
                        <span class="details-label">å¤§å°</span>
                        <span class="details-value">${formatFileSize(item.size)}</span>
                    </div>
                    <div class="details-row">
                        <span class="details-label">ä¿®æ”¹æ—¶é—´</span>
                        <span class="details-value">${item.modified ? formatDate(item.modified) : 'æœªçŸ¥'}</span>
                    </div>
                `;
            } else {
                content += `
                    <div class="details-row">
                        <span class="details-label">ç±»å‹</span>
                        <span class="details-value">æ–‡ä»¶å¤¹</span>
                    </div>
                `;
            }
            
            detailsContent.innerHTML = content;
            detailsPanel.classList.add('open');
        }
        
        // å³é”®èœå•
        function showContextMenu(x, y) {
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.classList.add('show');
        }
        
        // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
        function updateBreadcrumb() {
            breadcrumb.innerHTML = '';
            
            pathHistory.forEach((handle, index) => {
                const item = document.createElement('span');
                item.className = 'breadcrumb-item';
                item.textContent = handle.name || 'æ ¹ç›®å½•';
                
                item.addEventListener('click', async () => {
                    pathHistory = pathHistory.slice(0, index + 1);
                    currentDirectoryHandle = handle;
                    
                    historyIndex++;
                    navigationHistory = navigationHistory.slice(0, historyIndex);
                    navigationHistory.push({
                        handle,
                        path: [...pathHistory]
                    });
                    
                    await loadDirectoryContents(handle);
                    updateBreadcrumb();
                    updateNavigationButtons();
                });
                
                breadcrumb.appendChild(item);
                
                if (index < pathHistory.length - 1) {
                    const sep = document.createElement('span');
                    sep.className = 'breadcrumb-separator';
                    sep.textContent = ' â€º ';
                    breadcrumb.appendChild(sep);
                }
            });
        }
        
        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavigationButtons() {
            backBtn.disabled = historyIndex <= 0;
            forwardBtn.disabled = historyIndex >= navigationHistory.length - 1;
            upBtn.disabled = pathHistory.length <= 1;
        }
        
        // åé€€
        async function goBack() {
            if (historyIndex > 0) {
                historyIndex--;
                const state = navigationHistory[historyIndex];
                currentDirectoryHandle = state.handle;
                pathHistory = [...state.path];
                await loadDirectoryContents(state.handle);
                updateBreadcrumb();
                updateNavigationButtons();
            }
        }
        
        // å‰è¿›
        async function goForward() {
            if (historyIndex < navigationHistory.length - 1) {
                historyIndex++;
                const state = navigationHistory[historyIndex];
                currentDirectoryHandle = state.handle;
                pathHistory = [...state.path];
                await loadDirectoryContents(state.handle);
                updateBreadcrumb();
                updateNavigationButtons();
            }
        }
        
        // å‘ä¸Š
        async function goUp() {
            if (pathHistory.length > 1) {
                pathHistory.pop();
                const parentHandle = pathHistory[pathHistory.length - 1];
                currentDirectoryHandle = parentHandle;
                
                historyIndex++;
                navigationHistory = navigationHistory.slice(0, historyIndex);
                navigationHistory.push({
                    handle: parentHandle,
                    path: [...pathHistory]
                });
                
                await loadDirectoryContents(parentHandle);
                updateBreadcrumb();
                updateNavigationButtons();
            }
        }
        
        // åˆ·æ–°
        async function refreshDirectory() {
            if (currentDirectoryHandle) {
                await loadDirectoryContents(currentDirectoryHandle);
            }
        }
        
        // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
        function updateSortIndicator() {
            document.querySelectorAll('.header-cell').forEach(cell => {
                const icon = cell.querySelector('.sort-icon');
                if (icon) icon.remove();
            });
            
            const activeCell = document.querySelector(`.header-cell[data-sort="${sortBy}"]`);
            if (activeCell) {
                const icon = document.createElement('span');
                icon.className = 'sort-icon';
                icon.textContent = sortAsc ? 'â–²' : 'â–¼';
                activeCell.appendChild(icon);
            }
        }
        
        // è·å–æ–‡ä»¶ç±»å‹
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const types = {
                'txt': 'æ–‡æœ¬æ–‡æ¡£',
                'doc': 'Word æ–‡æ¡£',
                'docx': 'Word æ–‡æ¡£',
                'xls': 'Excel è¡¨æ ¼',
                'xlsx': 'Excel è¡¨æ ¼',
                'ppt': 'PowerPoint æ¼”ç¤º',
                'pptx': 'PowerPoint æ¼”ç¤º',
                'pdf': 'PDF æ–‡æ¡£',
                'jpg': 'JPEG å›¾åƒ',
                'jpeg': 'JPEG å›¾åƒ',
                'png': 'PNG å›¾åƒ',
                'gif': 'GIF å›¾åƒ',
                'bmp': 'BMP å›¾åƒ',
                'svg': 'SVG å›¾åƒ',
                'mp3': 'MP3 éŸ³é¢‘',
                'wav': 'WAV éŸ³é¢‘',
                'mp4': 'MP4 è§†é¢‘',
                'avi': 'AVI è§†é¢‘',
                'mkv': 'MKV è§†é¢‘',
                'zip': 'ZIP å‹ç¼©åŒ…',
                'rar': 'RAR å‹ç¼©åŒ…',
                '7z': '7-Zip å‹ç¼©åŒ…',
                'html': 'HTML æ–‡ä»¶',
                'css': 'CSS æ ·å¼è¡¨',
                'js': 'JavaScript æ–‡ä»¶',
                'json': 'JSON æ–‡ä»¶',
                'xml': 'XML æ–‡ä»¶',
                'py': 'Python æ–‡ä»¶',
                'java': 'Java æ–‡ä»¶',
                'c': 'C æºæ–‡ä»¶',
                'cpp': 'C++ æºæ–‡ä»¶',
                'h': 'C/C++ å¤´æ–‡ä»¶',
                'exe': 'åº”ç”¨ç¨‹åº',
                'dll': 'DLL æ–‡ä»¶',
                'md': 'Markdown æ–‡ä»¶'
            };
            return types[ext] || `${ext.toUpperCase()} æ–‡ä»¶`;
        }
        
        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'txt': 'ğŸ“',
                'doc': 'ğŸ“˜',
                'docx': 'ğŸ“˜',
                'xls': 'ğŸ“Š',
                'xlsx': 'ğŸ“Š',
                'ppt': 'ğŸ“™',
                'pptx': 'ğŸ“™',
                'pdf': 'ğŸ“•',
                'jpg': 'ğŸ–¼ï¸',
                'jpeg': 'ğŸ–¼ï¸',
                'png': 'ğŸ–¼ï¸',
                'gif': 'ğŸ–¼ï¸',
                'bmp': 'ğŸ–¼ï¸',
                'svg': 'ğŸ–¼ï¸',
                'mp3': 'ğŸµ',
                'wav': 'ğŸµ',
                'mp4': 'ğŸ¬',
                'avi': 'ğŸ¬',
                'mkv': 'ğŸ¬',
                'zip': 'ğŸ“¦',
                'rar': 'ğŸ“¦',
                '7z': 'ğŸ“¦',
                'html': 'ğŸŒ',
                'css': 'ğŸ¨',
                'js': 'âš¡',
                'json': 'ğŸ“‹',
                'xml': 'ğŸ“‹',
                'py': 'ğŸ',
                'java': 'â˜•',
                'exe': 'âš™ï¸',
                'md': 'ğŸ“'
            };
            return icons[ext] || 'ğŸ“„';
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }
        
        // æ˜¾ç¤º/éšè—çŠ¶æ€
        function showLoading() {
            loading.style.display = 'flex';
            fileList.style.display = 'none';
            emptyState.style.display = 'none';
            errorState.style.display = 'none';
        }
        
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        function showError() {
            loading.style.display = 'none';
            fileList.style.display = 'none';
            emptyState.style.display = 'none';
            errorState.style.display = 'flex';
        }
        
        // å…¼å®¹æ€§æ£€æŸ¥
        if (!window.showDirectoryPicker) {
            emptyState.innerHTML = `
                <div class="icon">âš ï¸</div>
                <h3>æµè§ˆå™¨ä¸æ”¯æŒ</h3>
                <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ File System Access API<br>
                è¯·ä½¿ç”¨ Chrome 86+ã€Edge 86+ æˆ– Opera 72+ ç­‰ç°ä»£æµè§ˆå™¨</p>
            `;
            selectRootBtn.disabled = true;
            addFolderBtn.disabled = true;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        async function init() {
            try {
                await initDB();
                // æ¸²æŸ“å·²ä¿å­˜çš„æ–‡ä»¶å¤¹åˆ—è¡¨
                await renderSavedFolders();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // å¯åŠ¨åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
